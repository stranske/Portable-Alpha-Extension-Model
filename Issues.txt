Issue 1 — Wizard: add Advanced Simulation Settings UI + YAML wiring (returns, copula, vol regime, shrinkage, repair, backend)
# AGENT_ISSUE_TEMPLATE

## Why

Issue #957 identifies several `ModelConfig` fields that exist in the backend but are not exposed in the Streamlit Scenario Wizard, and therefore cannot be set via the UI or persisted into the wizard-generated YAML.

This creates two problems:
1) Users cannot access advanced behaviors (Student-t, copula, two-state vol regime, shrinkage/repair modes) from the UI.
2) The wizard-generated YAML cannot reproduce those settings, making runs harder to audit and reproduce.

## Scope

Add an "Advanced Simulation Settings" panel to the Scenario Wizard that:
- exposes key advanced `ModelConfig` fields
- persists them into the config view (`pa_core/wizard_schema.py`)
- writes them into the wizard YAML via `_build_yaml_from_config()`
- adds tests ensuring end-to-end wiring from UI config → YAML dict → `ModelConfig`

Fields to include (from #957):
- `return_distribution`, `return_t_df`, `return_copula`
- `vol_regime`, `vol_regime_window`
- `covariance_shrinkage`
- `correlation_repair_mode`, `correlation_repair_shrinkage`
- `backend`

## Non-Goals

- Building a fully general GUI editor for complex nested objects (handled in a separate regime switching issue).
- Changing defaults or simulation behavior beyond wiring.
- Adding GPU/cupy support if it is not already supported; backend UI may be “numpy only” for now.

## Tasks

- [x] Create `pa_core/reporting/agent_semantics.py` with `build_agent_semantics(cfg: ModelConfig) -> pd.DataFrame`.
- [x] Include columns: `Agent`, `capital_mm`, `implied_capital_share`, `beta_coeff_used`, `alpha_coeff_used`, `financing_coeff_used`, `notes`, `mismatch_flag`.
- [x] Implement built-in agent rules:
  - Base: beta_coeff = beta_share, alpha_coeff = alpha_share, financing_coeff = -beta_share
  - ExternalPA: beta_coeff = beta_share, alpha_coeff = beta_share * theta_extpa (from extra), financing_coeff = -beta_share
  - ActiveExt: beta_coeff = beta_share, alpha_coeff = beta_share * active_share (from extra), financing_coeff = -beta_share
  - InternalPA: beta_coeff = 0, alpha_coeff = alpha_share, financing_coeff = 0
  - InternalBeta: beta_coeff = beta_share, alpha_coeff = 0, financing_coeff = -beta_share
  - Unknown/custom agents: treat beta_coeff = beta_share and alpha_coeff = alpha_share; set notes indicating semantics depend on implementation.
- [x] Flag mismatch when `abs(implied_capital_share - beta_share)` (ExternalPA/ActiveExt/InternalBeta) or `abs(implied_capital_share - alpha_share)` (InternalPA) exceeds tolerance (e.g., 1e-6).
- [x] Attach the DataFrame to run exports by adding `inputs["_agent_semantics_df"] = df` in `pa_core/facade.py` (RunArtifacts inputs).
- [x] Update `pa_core/reporting/excel.py` to write `_agent_semantics_df` to a new sheet `AgentSemantics` when present.
- [x] Add unit tests in `tests/test_reporting_agent_semantics.py` to verify coefficients and mismatch detection for a small config with Base/ExternalPA/ActiveExt/InternalPA.
- [x] Update documentation (`docs/UserGuide.md` or `docs/guides/PARAMETER_GUIDE.md`) with a short explanation of the `AgentSemantics` sheet and how to interpret it.

## Acceptance Criteria

- [ ] Running `pa run` produces an Excel workbook containing a sheet named `AgentSemantics`.
- [ ] The sheet contains the specified columns and rows for all built-in agents present in config.
- [ ] For ExternalPA and ActiveExt, `alpha_coeff_used` equals `beta_share * theta_extpa` and `beta_share * active_share` respectively.
- [ ] Mismatch flags trigger when implied capital share differs materially from the contribution scaling used.
- [ ] All tests pass and no existing simulation output tests regress.

## Implementation Notes

Files likely involved:
- `pa_core/reporting/agent_semantics.py` (new)
- `pa_core/facade.py` (attach `_agent_semantics_df` to inputs)
- `pa_core/reporting/excel.py` (write `AgentSemantics` sheet)
- `pa_core/config.py` (use `total_fund_capital` and existing compiled agents list)
- `pa_core/agents/*.py` (reference semantics only; do not change)

2 — Export correlation repair diagnostics (before/after matrices) + optional max-delta guardrail
## Why

Correlation repair is correctly applied and logged, and summary stats are stored in `_correlation_repair_info`, but the actual matrices used (before vs after) are not exported. That makes it hard to audit when “inputs were repaired” materially.

We should export:
- correlation matrix before repair
- correlation matrix after repair
- delta matrix (after - before)
- a small “repair info” table (min eigen before/after, max delta, mode, shrinkage)

Optionally, users should be able to fail a run when the repair delta is too large.

- [ ] Update `dashboard/pages/3_Scenario_Wizard.py`:
  - [ ] Add an "Advanced Simulation Settings" UI section (expander or dedicated step).
  - [ ] Add UI controls and store values into the config view and/or session_state consistently.
  - [ ] Ensure these values are used when building the wizard config object.

- [ ] Update `dashboard/pages/3_Scenario_Wizard.py::_build_yaml_from_config()`:
  - [ ] Emit the advanced fields into the YAML dict using the canonical `ModelConfig` keys (snake_case), alongside existing keys.

- [ ] Tests:
  - [ ] Update `tests/test_wizard_schema.py` to assert `DefaultConfigView` includes the new fields and that defaults are valid.
  - [ ] Update `tests/test_wizard_config_wiring.py` to:
    - set non-default values for these new fields in the config view
    - assert `_build_yaml_from_config()` includes them
    - assert `ModelConfig.model_validate(yaml_dict)` reflects them correctly.

- [x] Update `pa_core/sim/paths.py::_resolve_correlation_matrix()` to include `corr_before` and `corr_after` in the returned `info` dict (nested lists or small arrays).
- [ ] Add `correlation_repair_max_abs_delta: float | None` to `ModelConfig` in `pa_core/config.py` (default: None).
- [ ] In `_resolve_correlation_matrix()`, if `correlation_repair_max_abs_delta` is not None and `repair_applied` is True, raise `ValueError` when `max_abs_delta > threshold`, including both values in the message.
- [ ] In `pa_core/facade.py::run_single()`, when `corr_repair_info` exists, construct DataFrames:
  - `inputs["_corr_before_df"]`
  - `inputs["_corr_after_df"]`
  - `inputs["_corr_delta_df"]`
  - `inputs["_corr_repair_info_df"]` (one-row table of scalar diagnostics)
- [ ] Update `pa_core/reporting/excel.py` to write these DataFrames to sheets (short names):
  - `CorrInput`, `CorrUsed`, `CorrDelta`, `CorrRepairInfo`
- [ ] Add tests:
  - [x] `tests/test_return_distributions.py` (or new file) asserts repair info contains `corr_before` and `corr_after`.
  - [ ] Add a test that sets `correlation_repair_max_abs_delta` small and confirms a ValueError is raised when repair applied with larger delta.
  - [ ] Add a test that `run_single()` attaches the `_corr_*_df` keys to `RunArtifacts.inputs` when repair applied.
- [ ] Update documentation (`docs/UserGuide.md`) describing where to find correlation repair diagnostics in exports.

## Acceptance Criteria

- [ ] Wizard UI exposes the advanced settings listed in Scope.
- [ ] `_build_yaml_from_config()` includes these settings in its output dict.
- [ ] The resulting YAML dict validates into `ModelConfig` with the expected values.
- [ ] `tests/test_wizard_schema.py` and `tests/test_wizard_config_wiring.py` cover all added fields and pass in CI.
- [ ] Documentation notes the new coverage.

## Implementation Notes

Files referenced by #957:
- `dashboard/pages/3_Scenario_Wizard.py` (UI + `_build_yaml_from_config()`)
- `pa_core/wizard_schema.py` (DefaultConfigView)
- `tests/test_wizard_config_wiring.py`, `tests/test_wizard_schema.py`

Issue 2 — Wizard: add Regime Switching UI + YAML wiring (regimes, transition matrix, start regime)
# AGENT_ISSUE_TEMPLATE

## Why

Issue #957 notes that regime switching exists in `ModelConfig` (from prior work) but has no wizard UI and is not persisted in wizard YAML output. That prevents users from configuring regimes via the dashboard and makes the feature effectively CLI-only.

## Scope

Add a minimal-but-usable UI for regime switching in the Scenario Wizard:
- enable/disable regime switching
- define `regimes`
- define `regime_transition`
- define `regime_start`
- persist these fields into wizard YAML via `_build_yaml_from_config()`

Prefer a pragmatic UX that avoids complex grid editors:
- Use structured inputs where easy (toggle + dropdown for start regime)
- Use YAML/JSON text areas for regimes list and transition matrix, with validation and helpful errors.

## Non-Goals

- A full matrix editor UI.
- Automatic inference of regime parameters from data.
- Changing regime simulation logic.

## Tasks

- [ ] Update `pa_core/wizard_schema.py`:
  - [ ] Extend `DefaultConfigView` to include optional regime fields:
    - `regimes` (optional list/dict structure or a raw YAML field that is parsed before YAML build)
    - `regime_transition` (optional list-of-lists or parsed structure)
    - `regime_start` (optional string)

- [ ] Update `dashboard/pages/3_Scenario_Wizard.py`:
  - [ ] Add a "Regime Switching" section:
    - [ ] Toggle: enable regime switching
    - [ ] Text area: regimes YAML/JSON
    - [ ] Text area: transition matrix YAML/JSON
    - [ ] Input/select: starting regime (optional; validate it exists in regimes)
  - [ ] Add parsing/validation that:
    - fails loudly with actionable messages if YAML/JSON cannot be parsed
    - checks transition matrix dimensions match number of regimes
    - checks probabilities rows sum ~ 1.0 (tolerance)

- [ ] Update `dashboard/pages/3_Scenario_Wizard.py::_build_yaml_from_config()`:
  - [ ] When regime switching enabled, emit:
    - `regimes`
    - `regime_transition`
    - `regime_start`

- [ ] Tests:
  - [ ] Add `tests/test_wizard_regime_wiring.py` (or extend `test_wizard_config_wiring.py`) to:
    - provide a minimal 2-regime configuration
    - assert YAML dict contains the expected keys
    - assert `ModelConfig.model_validate(yaml_dict)` succeeds

- [ ] Documentation:
  - [ ] Update `docs/UserGuide.md` (or wizard docs) with a short “Regime Switching via Wizard” example including a minimal two-state spec.

## Acceptance Criteria

- [ ] Wizard can accept a valid regime switching specification and persist it into YAML.
- [ ] Invalid YAML/JSON for regimes or transition yields an actionable error in the UI.
- [ ] The generated YAML validates into `ModelConfig` with regimes enabled.
- [ ] Tests cover the wiring and pass in CI.

## Implementation Notes

Keep the initial UI minimal and robust. A text-area based approach is acceptable for advanced users and avoids a lot of fragile UI logic.

Issue 3 — Sleeve constraint settings: persist into YAML/ModelConfig and optionally validate runs
# AGENT_ISSUE_TEMPLATE

## Why

Issue #957 notes that sleeve constraint settings in the wizard (`sleeve_max_te`, `sleeve_max_breach`, `sleeve_max_cvar`, `sleeve_max_shortfall`, `sleeve_constraint_scope`) currently affect sleeve suggestion only, but do not flow into the main simulation configuration.

This creates confusion: the wizard suggests solutions using constraints, but a subsequent run cannot record or enforce the same constraint set.

## Scope

- Persist sleeve constraint settings into the wizard YAML output and `ModelConfig`.
- Add an optional “validate constraints on run” behavior (default off to avoid breaking existing flows).
- Reuse existing constraint evaluation utilities if present (e.g., `pa_core/reporting/constraints.py`); otherwise implement a small validator.

## Non-Goals

- Turning the simulation into an optimizer.
- Automatically changing sleeve allocations to satisfy constraints.
- Changing existing suggestor behavior unless necessary for consistency.

## Tasks

- [ ] Add fields to `ModelConfig` (in `pa_core/config.py`) if not already present:
  - `sleeve_max_te: float | None`
  - `sleeve_max_breach: float | None`
  - `sleeve_max_cvar: float | None`
  - `sleeve_max_shortfall: float | None`
  - `sleeve_constraint_scope: Literal["total", "per_sleeve"]`
  - `sleeve_validate_on_run: bool` (default False)

- [ ] Update `pa_core/wizard_schema.py`:
  - [ ] Add these fields to `DefaultConfigView` with sensible defaults (None + total + False).

- [ ] Update `dashboard/pages/3_Scenario_Wizard.py`:
  - [ ] Wire existing UI inputs (already in session_state) into the config view.
  - [ ] Add a checkbox “Validate constraints on run” that maps to `sleeve_validate_on_run`.

- [ ] Update `dashboard/pages/3_Scenario_Wizard.py::_build_yaml_from_config()`:
  - [ ] Emit the sleeve constraint fields into the YAML dict.

- [ ] Implement validation on run (facade layer):
  - [ ] Add `validate_sleeve_constraints(summary_df: pd.DataFrame, cfg: ModelConfig) -> list[str]` (return list of violations) in `pa_core/reporting/constraints.py` (or a new module).
  - [ ] In `pa_core/facade.run_single()`, after `summary_table()`:
    - If `cfg.sleeve_validate_on_run` is True, evaluate constraints.
    - If violations exist:
      - raise `ValueError` with a readable multi-line summary of violations
      - OR (if preferred) attach violations to inputs metadata and print a warning (choose one; default should be explicit and testable).

- [ ] Tests:
  - [ ] Extend `tests/test_wizard_config_wiring.py` to assert the new fields appear in YAML dict and validate into `ModelConfig`.
  - [ ] Add `tests/test_sleeve_constraint_validation.py`:
    - Provide a fake summary DataFrame with `monthly_TE`, `monthly_BreachProb`, `monthly_CVaR`, `terminal_ShortfallProb` columns (or the canonical column names used by your constraints utilities).
    - Confirm violations are detected correctly for both `total` and `per_sleeve` scope.
    - Confirm `run_single()` raises when `sleeve_validate_on_run=True` and violations exist.

- [ ] Documentation:
  - [ ] Update docs to state clearly:
    - constraints are used by suggestor
    - constraints can optionally be validated for a single run when enabled

## Acceptance Criteria

- [ ] Wizard persists sleeve constraint values into YAML and they validate into `ModelConfig`.
- [ ] When `sleeve_validate_on_run=True`, a run with violating metrics fails (or records violations) deterministically.
- [ ] Tests cover both wiring and validation paths and pass in CI.
- [ ] Documentation clarifies behavior and avoids user confusion.

## Implementation Notes

This closes the “constraints don’t flow to main simulation” gap in #957 while keeping default behavior unchanged unless explicitly enabled.

Issue 4 — Seed propagation: make wizard seed behavior consistent and testable (CLI + in-process runs)
# AGENT_ISSUE_TEMPLATE

## Why

Issue #957 flags a risk that “seed is passed to CLI but may not cover all paths.” The codebase now supports programmatic runs via `pa_core.facade.RunOptions(seed=...)`, but the dashboard/wizard must consistently:
- store seed intent (enabled vs disabled)
- pass seed to CLI runs
- pass seed to in-process runs (e.g., sleeve suggestor workflows) when applicable
- provide tests to prevent regressions

## Scope

- Standardize how seed is represented in wizard state/config (enabled + value).
- Ensure dashboard CLI invocation includes `--seed` only when enabled.
- Ensure any in-process calls (suggestor/grid/sweep) receive the same seed through `RunOptions` or explicit arguments.
- Add tests verifying command construction and seed propagation.

## Non-Goals

- Making seed part of `ModelConfig` (seed belongs in RunOptions / CLI args).
- Changing RNG semantics (already stabilized elsewhere).

## Tasks

- [ ] Wizard/UI:
  - [ ] Ensure wizard has explicit `use_seed` toggle and `seed_value` input in session_state/config view.
  - [ ] Default: `use_seed=True` and `seed_value=42` (or current behavior).

- [ ] Dashboard CLI wiring:
  - [ ] Update `dashboard/cli.py` (or where CLI command is built) so:
    - `--seed <value>` is included only when `use_seed=True`
    - when `use_seed=False`, the command omits `--seed` entirely

- [ ] In-process runs:
  - [ ] Where the dashboard invokes backend logic directly (e.g., sleeve suggestor), ensure seed is passed through `RunOptions(seed=seed_value)` or equivalent.

- [ ] Tests:
  - [ ] Update/add `tests/test_dashboard_cli.py`:
    - verify `--seed` is present when enabled
    - verify `--seed` is absent when disabled
  - [ ] Add a small unit test for in-process suggestor call signature (mock/monkeypatch) ensuring seed is forwarded.

- [ ] Documentation:
  - [ ] Update a short section in wizard docs stating:
    - what seed does
    - how disabling seed changes reproducibility

## Acceptance Criteria

- [ ] Wizard has explicit seed toggle + value, and these are used when invoking runs.
- [ ] Dashboard CLI commands include/omit `--seed` correctly.
- [ ] In-process runs consistently receive the seed when enabled.
- [ ] Tests cover both enabled and disabled behavior and pass in CI.

## Implementation Notes

Prefer deterministic tests that validate command construction and argument plumbing rather than trying to assert stochastic output differences.
