name: Streamlined Codex Auto-Debug

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize]
  push:
    branches: [ 'codex/**' ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number (when dispatched by debug-on-failure)'
        required: false
      target_ref:
        description: 'Git ref to check out (e.g., refs/pull/123/head)'
        required: false
      pr_head_ref:
        description: 'PR head ref (branch name) for logs only'
        required: false
      pr_head_sha:
        description: 'PR head SHA for logs only'
        required: false
      debug_mode:
        description: 'Enable verbose debugging'
        required: false
        default: 'false'

# Least-privilege permissions for what this job actually does
permissions:
  contents: write        # push auto-fixes to same-repo branches
  pull-requests: write   # comment on PRs
  issues: write          # PRs are issues; needed to comment

concurrency:
  group: codex-auto-debug-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.ref_name || github.run_id }}
  cancel-in-progress: true

jobs:
  streamlined-debug:
    runs-on: ubuntu-latest

    # Run on codex branches, PRs to main, or manual dispatch (from Option A router)
    if: >
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.head_ref || '', 'codex/') ||
      startsWith(github.ref_name || '', 'codex/') ||
      github.event_name == 'pull_request'

    env:
      # prefer personal token if present, otherwise fall back
      CODEX_TOKEN: ${{ secrets.CODEX_PAT || secrets.GITHUB_TOKEN }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
      - name: üßæ Resolve target checkout ref
        id: resolve
        run: |
          # Priority:
          # 1) workflow_dispatch input target_ref (e.g., refs/pull/123/head)
          # 2) pull_request head ref
          # 3) push ref_name
          # 4) repo default branch as absolute last resort
          TARGET_REF="${{ github.event.inputs.target_ref }}"
          if [ -z "$TARGET_REF" ]; then
            if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "${{ github.head_ref }}" ]; then
              TARGET_REF="${{ github.head_ref }}"
            elif [ -n "${{ github.ref_name }}" ]; then
              TARGET_REF="${{ github.ref_name }}"
            else
              TARGET_REF="${{ github.event.repository.default_branch || 'main' }}"
            fi
          fi
          echo "target_ref=$TARGET_REF" >> "$GITHUB_OUTPUT"

      - name: üì• Check out code at target ref
        uses: actions/checkout@v4
        with:
          token: ${{ env.CODEX_TOKEN }}
          ref: ${{ steps.resolve.outputs.target_ref }}
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found; installing minimal toolchain"
            pip install --upgrade pip
          fi

      - name: üß≠ Set up Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ‚öôÔ∏è Initialize debug status
        run: |
          echo "streamlined_code=0" >> $GITHUB_ENV
          echo "detailed_code=0" >> $GITHUB_ENV

      - name: üöÄ Run Streamlined Debug
        id: streamlined_debug
        run: |
          echo "Running streamlined debugging workflow..."
          exit_code=0
          if [ -f scripts/streamlined_debug.py ]; then
            python scripts/streamlined_debug.py
            exit_code=$?
            if [ $exit_code -ne 0 ]; then
              echo "ERROR: streamlined_debug.py failed with exit code $exit_code" >&2
            fi
          else
            echo "ERROR: scripts/streamlined_debug.py not found!" >&2
            exit_code=2
          fi
          echo "streamlined_exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "streamlined_code=$exit_code" >> $GITHUB_ENV

      - name: üìä Upload Streamlined Debug Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: streamlined-debug-report-${{ github.run_id }}
          path: |
            streamlined_debug_report.md
          if-no-files-found: ignore

      - name: üîç Run Detailed Debug (if streamlined found issues)
        id: detailed_debug
        if: steps.streamlined_debug.outputs.streamlined_exit_code != '0'
        run: |
          echo "Streamlined debug found issues. Running detailed analysis..."
          BRANCH_IN="${{ github.event.inputs.pr_head_ref || github.head_ref || github.ref_name }}"
          python scripts/debug_codex_pr.py \
            --branch="$BRANCH_IN" \
            --report=detailed_debug_report.md \
            --max-iterations=3 \
            --commit
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "ERROR: debug_codex_pr.py failed with exit code $exit_code" >&2
          fi
          # never fail the job here; final status handles that
          echo "detailed_exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "detailed_code=$exit_code" >> $GITHUB_ENV
          true

      - name: üìä Upload Detailed Debug Report
        if: steps.detailed_debug.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: detailed-debug-report-${{ github.run_id }}
          path: |
            detailed_debug_report.md
          if-no-files-found: ignore

      - name: üí¨ Comment results on PR
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number)
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CODEX_TOKEN }}
          script: |
            const fs = require('fs');
            const streamlinedExit = '${{ steps.streamlined_debug.outputs.streamlined_exit_code }}';
            const detailedRan = '${{ steps.detailed_debug.outcome }}' !== 'skipped';
            const prNumber = context.payload.pull_request?.number || Number(core.getInput('pr_number')) || Number('${{ github.event.inputs.pr_number || '' }}');

            let streamlinedReport = '';
            try { streamlinedReport = fs.readFileSync('streamlined_debug_report.md','utf8'); }
            catch { streamlinedReport = '‚ùå Streamlined debug report not generated.'; }

            let detailedReport = '';
            try { detailedReport = fs.readFileSync('detailed_debug_report.md','utf8'); }
            catch {}

            const streamlinedPassed = String(streamlinedExit) === '0';
            const statusEmoji = streamlinedPassed ? 'üéâ' : '‚ö†Ô∏è';
            const statusText  = streamlinedPassed ? 'All Checks Passed' : 'Issues Found';

            let comment = `## ${statusEmoji} Automated Codex Debugging Results - ${statusText}

            ### üöÄ Streamlined Debug Results
            ${streamlinedReport}
            `;

            if (detailedRan && detailedReport) {
              comment += `\n### üîç Detailed Debug Results\n${detailedReport}\n`;
            }

            comment += `\n---\n*Debug workflow: Streamlined ‚Üí ${streamlinedPassed ? 'Passed ‚úÖ' : 'Failed ‚ùå'}${detailedRan ? ' ‚Üí Detailed Analysis üîç' : ''}*`;

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            } else {
              core.info('No PR number available; skipping PR comment.');
            }

      - name: ü§ñ Auto-commit fixes if any
        if: >
          (steps.streamlined_debug.outputs.streamlined_exit_code == '0' ||
           steps.detailed_debug.outputs.detailed_exit_code == '0') &&
          github.event_name != 'workflow_dispatch'
        run: |
          # Only attempt to push for same-repo branches; fork PRs will fail without extra perms
          REPO_FULL="${{ github.repository }}"
          HEAD_REPO_FULL="${{ github.event.pull_request.head.repo.full_name || github.repository }}"
          if [ "$REPO_FULL" != "$HEAD_REPO_FULL" ]; then
            echo "Skipping auto-push for fork PR ($HEAD_REPO_FULL)."
            exit 0
          fi

          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected, committing fixes..."
            git add -A
            git commit -m "ü§ñ Auto-fix: Codex debugging workflow applied minor fixes"
            if git push; then
              echo "‚úÖ Successfully pushed auto-fixes"
            else
              echo "‚ùå Failed to push auto-fixes; check branch protections/permissions"
              exit 1
            fi
          else
            echo "‚úÖ No changes to commit"
          fi

      - name: üìã Set final status
        if: always()
        run: |
          : "${streamlined_code:=1}"
          : "${detailed_code:=1}"
          if [ "$streamlined_code" = "0" ]; then
            echo "‚úÖ Streamlined debug passed - all good!"
            exit 0
          elif [ "$detailed_code" = "0" ]; then
            echo "‚úÖ Detailed debug resolved issues - all good!"
            exit 0
          else
            echo "‚ö†Ô∏è Issues remain that need manual attention"
            exit 1
          fi
